{
  "$schema": "./features.schema.json",
  "version": "1.0.0",
  "description": "Basilisk AV Feature Tracking - Inline Strudel Visualizations",
  "lastUpdated": "2025-12-21",
  "features": [
    {
      "id": "p6-inline-viz-infrastructure",
      "name": "Inline Visualization Infrastructure",
      "status": "complete",
      "description": "Core infrastructure for inline visualization widgets",
      "completedDate": "2025-12-18",
      "files": [
        "src/services/visualizationManager.ts",
        "src/hooks/useWidgetUpdates.ts",
        "src/services/strudelEngine.ts",
        "src/components/StrudelRepl.tsx"
      ],
      "verificationCriteria": [
        {
          "description": "VisualizationManager singleton exists and is exported",
          "type": "code-exists",
          "verified": true
        },
        {
          "description": "Widget registration via registerWidget() method",
          "type": "code-exists",
          "verified": true
        },
        {
          "description": "Animation loop queries pattern via getCurrentPattern()",
          "type": "code-exists",
          "verified": true
        },
        {
          "description": "Time synchronization via getCurrentTime()",
          "type": "code-exists",
          "verified": true
        },
        {
          "description": "Audio analyser connected for audio-reactive visualizations",
          "type": "code-exists",
          "verified": true
        },
        {
          "description": "Console logs show '[VizManager] Registering widget:' on widget creation",
          "type": "manual-test",
          "verified": true
        }
      ]
    },
    {
      "id": "p6-inline-scope",
      "name": "Inline Scope Visualization (._scope())",
      "status": "complete",
      "description": "Oscilloscope waveform visualization using Web Audio API analyser",
      "completedDate": "2025-12-18",
      "files": [
        "src/services/visualizationManager.ts"
      ],
      "testCommand": "s(\"bd sd hh sd\")._scope()",
      "verificationCriteria": [
        {
          "description": "Canvas element appears inline below the code",
          "type": "manual-test",
          "verified": true
        },
        {
          "description": "Oscilloscope waveform displays (NOT a black canvas)",
          "type": "manual-test",
          "verified": true
        },
        {
          "description": "Waveform updates in real-time (~60fps via requestAnimationFrame)",
          "type": "manual-test",
          "verified": true
        },
        {
          "description": "Waveform reflects audio output accurately",
          "type": "manual-test",
          "verified": true
        },
        {
          "description": "Console shows: '[VizManager] Drawing scope to canvas'",
          "type": "console-log",
          "verified": true
        },
        {
          "description": "Re-evaluating pattern updates the visualization",
          "type": "manual-test",
          "verified": true
        }
      ]
    },
    {
      "id": "p6-inline-pianoroll",
      "name": "Inline Pianoroll Visualization (._pianoroll())",
      "status": "complete",
      "description": "Horizontal piano roll showing note events over time",
      "completedDate": "2025-12-18",
      "files": [
        "src/services/visualizationManager.ts"
      ],
      "testCommand": "note(\"c e g\")._pianoroll({ cycles: 2 })",
      "verificationCriteria": [
        {
          "description": "Canvas element appears inline below the code",
          "type": "manual-test",
          "verified": true
        },
        {
          "description": "Piano roll displays notes (NOT a black canvas)",
          "type": "manual-test",
          "verified": true
        },
        {
          "description": "Notes appear at correct MIDI pitches (C, E, G as horizontal bars)",
          "type": "manual-test",
          "verified": true
        },
        {
          "description": "Playhead (white vertical line) scrolls showing current position",
          "type": "manual-test",
          "verified": true
        },
        {
          "description": "Notes are visible with active/inactive colors",
          "type": "manual-test",
          "verified": true
        },
        {
          "description": "Console shows: '[VizManager] Drawing pianoroll - haps: [N]'",
          "type": "console-log",
          "verified": true
        },
        {
          "description": "Works with both note() and n() patterns",
          "type": "manual-test",
          "verified": true
        }
      ]
    },
    {
      "id": "p6-inline-punchcard",
      "name": "Inline Punchcard Visualization (._punchcard())",
      "status": "complete",
      "description": "Vertical piano roll (punchcard style) showing note events",
      "completedDate": "2025-12-18",
      "files": [
        "src/services/visualizationManager.ts"
      ],
      "testCommand": "note(\"c a f e\").euclid(5,8)._punchcard()",
      "verificationCriteria": [
        {
          "description": "Canvas element appears inline below the code",
          "type": "manual-test",
          "verified": true
        },
        {
          "description": "Punchcard displays (vertical pianoroll orientation)",
          "type": "manual-test",
          "verified": true
        },
        {
          "description": "Events show as colored bars",
          "type": "manual-test",
          "verified": true
        },
        {
          "description": "Console shows: '[VizManager] Drawing punchcard'",
          "type": "console-log",
          "verified": true
        }
      ]
    },
    {
      "id": "p6-inline-spiral",
      "name": "Inline Spiral Visualization (._spiral())",
      "status": "complete",
      "completedDate": "2025-12-20",
      "description": "Spiral visualization showing pattern events as arcs on a spiral",
      "priority": "medium",
      "files": [
        "src/services/visualizationManager.ts"
      ],
      "testCommand": "note(\"c e g b\")._spiral()",
      "dependencies": [],
      "implementationNotes": "Implemented spiral drawing using polar coordinate math (fromPolar, xyOnSpiral, spiralSegment). Adapted from @strudel/draw/spiral.mjs. Supports all configuration options: stretch, inset, margin, thickness, activeColor, inactiveColor, playheadColor, playheadLength, steady, fade, padding.",
      "linesAdded": 130,
      "verificationCriteria": [
        {
          "description": "Canvas element appears inline below the code",
          "type": "manual-test",
          "verified": true
        },
        {
          "description": "Spiral visualization renders (NOT placeholder text)",
          "type": "manual-test",
          "verified": true,
          "expectedBehavior": "Spiral arms emanate from center with pattern events as colored arcs"
        },
        {
          "description": "Events appear as arc segments along spiral arms",
          "type": "manual-test",
          "verified": true
        },
        {
          "description": "Spiral rotates with playback time",
          "type": "manual-test",
          "verified": true
        },
        {
          "description": "Console shows: '[VizManager] Drawing spiral - haps: [N]'",
          "type": "console-log",
          "verified": true
        },
        {
          "description": "Re-evaluating pattern updates the visualization",
          "type": "manual-test",
          "verified": true
        }
      ],
      "acceptanceCriteria": [
        "Spiral arms rotate continuously with current playback time",
        "Pattern events (haps) appear as colored arcs along the spiral",
        "Events in the past fade or change color vs future events",
        "margin option controls spacing between spiral arms",
        "No console errors during rendering"
      ]
    },
    {
      "id": "p6-inline-spectrum",
      "name": "Inline Spectrum Visualization (._spectrum())",
      "status": "complete",
      "completedDate": "2025-12-20",
      "description": "Frequency spectrum analyzer (FFT) visualization showing audio frequencies",
      "priority": "medium",
      "files": [
        "src/services/visualizationManager.ts",
        "src/services/strudelEngine.ts",
        "src/hooks/useWidgetUpdates.ts",
        "src/utils/patternWidgetRegistration.ts"
      ],
      "testCommand": "s(\"bd sd hh sd\")._spectrum()",
      "dependencies": [
        "Audio analyser must be connected (already done for _scope)"
      ],
      "implementationNotes": "Delegates to Strudel's analyze().draw() mechanism which handles scrolling spectrogram rendering. Visualization manager skips _spectrum widgets since Strudel handles them directly.",
      "linesAdded": 50,
      "verificationCriteria": [
        {
          "description": "_spectrum method exists on Pattern.prototype",
          "type": "code-exists",
          "verified": true
        },
        {
          "description": "'_spectrum' type added to WidgetConfig in strudelEngine.ts",
          "type": "code-exists",
          "verified": true
        },
        {
          "description": "'_spectrum' registered via registerWidgetType()",
          "type": "code-exists",
          "verified": true
        },
        {
          "description": "renderSpectrum() method exists in visualizationManager.ts",
          "type": "code-exists",
          "verified": true
        },
        {
          "description": "Canvas element appears inline below the code",
          "type": "manual-test",
          "verified": true
        },
        {
          "description": "Spectrum analyzer displays scrolling spectrogram (via Strudel's analyze().draw())",
          "type": "manual-test",
          "verified": true,
          "expectedBehavior": "Scrolling spectrogram showing frequency content over time"
        },
        {
          "description": "Spectrogram updates in real-time with audio playback",
          "type": "manual-test",
          "verified": true
        },
        {
          "description": "Low frequencies at bottom, high frequencies at top",
          "type": "manual-test",
          "verified": true
        },
        {
          "description": "Rendered by Strudel's analyze().draw() (skipped in viz manager)",
          "type": "code-exists",
          "verified": true
        }
      ],
      "acceptanceCriteria": [
        "Frequency bars render correctly using FFT data",
        "Bar heights normalized between minDb (-100) and maxDb (-30)",
        "Updates at ~60fps matching animation frame rate",
        "Works with any audio-producing pattern",
        "No console errors during rendering"
      ]
    },
    {
      "id": "p6-theme-context",
      "name": "Theme Context Provider",
      "status": "complete",
      "phase": 6,
      "category": "dark-mode",
      "description": "React context for theme state management with localStorage persistence. Light mode = original solid REPL, Dark mode = glassmorphism transparency.",
      "priority": "high",
      "dependencies": [],
      "completedDate": "2025-12-21",
      "files": [
        "src/contexts/ThemeContext.tsx",
        "src/App.tsx"
      ],
      "verificationCriteria": [
        {
          "description": "ThemeProvider wraps App component",
          "type": "code-exists",
          "verified": true
        },
        {
          "description": "useTheme hook returns theme and toggleTheme",
          "type": "code-exists",
          "verified": true
        },
        {
          "description": "Theme persists after page reload",
          "type": "manual-test",
          "verified": true
        },
        {
          "description": "Default theme is light (original solid REPL)",
          "type": "manual-test",
          "verified": true
        }
      ]
    },
    {
      "id": "p6-theme-toggle-button",
      "name": "Theme Toggle Button",
      "status": "complete",
      "phase": 6,
      "category": "dark-mode",
      "description": "Sun/Moon toggle button in header to switch themes",
      "priority": "high",
      "dependencies": ["p6-theme-context"],
      "completedDate": "2025-12-21",
      "files": [
        "src/components/AppHeader.tsx",
        "src/components/__tests__/AppHeader.test.tsx"
      ],
      "verificationCriteria": [
        {
          "description": "Toggle button visible in AppHeader",
          "type": "manual-test",
          "verified": true
        },
        {
          "description": "Button shows sun icon in light mode (click to go dark)",
          "type": "manual-test",
          "verified": true
        },
        {
          "description": "Button shows moon icon in dark mode (click to go light)",
          "type": "manual-test",
          "verified": true
        },
        {
          "description": "Click toggles between themes",
          "type": "manual-test",
          "verified": true
        },
        {
          "description": "Tooltip indicates current action",
          "type": "manual-test",
          "verified": true
        }
      ]
    },
    {
      "id": "p6-repl-dark-background",
      "name": "REPL Dark Mode Styling",
      "status": "complete",
      "phase": 6,
      "category": "dark-mode",
      "description": "REPL window uses semi-transparent glassmorphism in dark mode, original solid styling in light mode",
      "priority": "high",
      "dependencies": ["p6-theme-context"],
      "completedDate": "2025-12-21",
      "files": [
        "src/components/StrudelRepl.tsx"
      ],
      "verificationCriteria": [
        {
          "description": "Dark mode REPL has rgba(0,0,0,0.4) background with glassmorphism",
          "type": "manual-test",
          "verified": true
        },
        {
          "description": "Hydra visuals visible through REPL background in dark mode",
          "type": "manual-test",
          "verified": true
        },
        {
          "description": "Light mode REPL uses original Tailwind classes (no glassmorphism)",
          "type": "manual-test",
          "verified": true
        },
        {
          "description": "Backdrop blur applied only in dark mode",
          "type": "manual-test",
          "verified": true
        },
        {
          "description": "Border and rounded corners only in dark mode",
          "type": "manual-test",
          "verified": true
        }
      ]
    },
    {
      "id": "p6-codemirror-dark-theme",
      "name": "CodeMirror Dark Theme",
      "status": "complete",
      "phase": 6,
      "category": "dark-mode",
      "description": "Custom CodeMirror theme with muted syntax colors for dark mode",
      "priority": "high",
      "dependencies": ["p6-theme-context"],
      "completedDate": "2025-12-21",
      "files": [
        "src/themes/codemirrorDark.ts",
        "src/components/StrudelRepl.tsx"
      ],
      "verificationCriteria": [
        {
          "description": "Dark mode editor has light text on transparent background",
          "type": "manual-test",
          "verified": true
        },
        {
          "description": "Keywords highlighted in muted purple (#c792ea)",
          "type": "manual-test",
          "verified": true
        },
        {
          "description": "Strings highlighted in muted green (#c3e88d)",
          "type": "manual-test",
          "verified": true
        },
        {
          "description": "Comments styled italic gray (#6a737d)",
          "type": "manual-test",
          "verified": true
        },
        {
          "description": "Cursor visible as white",
          "type": "manual-test",
          "verified": true
        },
        {
          "description": "Selection uses semi-transparent white",
          "type": "manual-test",
          "verified": true
        },
        {
          "description": "Active line has subtle highlight",
          "type": "manual-test",
          "verified": true
        }
      ]
    },
    {
      "id": "p6-header-dark-adaptation",
      "name": "Header Dark Mode Styling",
      "status": "complete",
      "phase": 6,
      "category": "dark-mode",
      "description": "AppHeader uses transparent glassmorphism in dark mode, retains current styling in light mode",
      "priority": "medium",
      "dependencies": ["p6-theme-context"],
      "completedDate": "2025-12-21",
      "files": [
        "src/components/AppHeader.tsx"
      ],
      "verificationCriteria": [
        {
          "description": "Light mode header retains current styling",
          "type": "manual-test",
          "verified": true
        },
        {
          "description": "Dark mode header uses rgba(0,0,0,0.4) background",
          "type": "manual-test",
          "verified": true
        },
        {
          "description": "Dark mode header border uses rgba(255,255,255,0.1)",
          "type": "manual-test",
          "verified": true
        },
        {
          "description": "Button text/icons visible in both modes",
          "type": "manual-test",
          "verified": true
        },
        {
          "description": "Backdrop blur applied in dark mode",
          "type": "manual-test",
          "verified": true
        }
      ]
    },
    {
      "id": "p6-hud-dark-styling",
      "name": "HUD Dark Mode Styling",
      "status": "complete",
      "phase": 6,
      "category": "dark-mode",
      "description": "HUD uses semi-transparent background in dark mode (90% for readability), retains current styling in light mode",
      "priority": "medium",
      "dependencies": ["p6-theme-context"],
      "completedDate": "2025-12-21",
      "files": [
        "src/components/HydraCanvas.tsx"
      ],
      "verificationCriteria": [
        {
          "description": "Light mode HUD retains current styling",
          "type": "manual-test",
          "verified": true
        },
        {
          "description": "Dark mode HUD uses rgba(0,0,0,0.4) background",
          "type": "manual-test",
          "verified": true
        },
        {
          "description": "Dark mode HUD text uses muted gray (#a0a0a0)",
          "type": "manual-test",
          "verified": true
        },
        {
          "description": "FFT visualizers visible in both modes",
          "type": "manual-test",
          "verified": true
        }
      ]
    },
    {
      "id": "p6-dark-mode-css-fallbacks",
      "name": "Dark Mode CSS Fallbacks",
      "status": "complete",
      "phase": 6,
      "category": "dark-mode",
      "description": "CSS overrides for Strudel REPL components that don't accept theme props",
      "priority": "low",
      "dependencies": ["p6-codemirror-dark-theme"],
      "completedDate": "2025-12-21",
      "files": [
        "src/styles/dark-mode.css",
        "src/main.tsx"
      ],
      "verificationCriteria": [
        {
          "description": "CSS file with .dark class overrides exists",
          "type": "code-exists",
          "verified": true
        },
        {
          "description": "Strudel REPL editor inherits dark styles",
          "type": "manual-test",
          "verified": true
        },
        {
          "description": "No style conflicts or flickering",
          "type": "manual-test",
          "verified": true
        },
        {
          "description": "Gutter background transparent in dark mode",
          "type": "manual-test",
          "verified": true
        }
      ]
    }
  ],
  "summary": {
    "total": 13,
    "complete": 13,
    "pending": 0,
    "blocked": 0
  },
  "pendingWork": [],
  "testingInstructions": {
    "prerequisites": [
      "Start the dev server: npm run dev",
      "Open http://localhost:5174 in browser",
      "Click 'Start Audio' button",
      "Open browser DevTools Console (F12) to view debug logs"
    ],
    "testPatterns": {
      "_scope": "s(\"bd sd hh sd\")._scope()",
      "_pianoroll": "note(\"c e g\")._pianoroll({ cycles: 2 })",
      "_punchcard": "note(\"c a f e\").euclid(5,8)._punchcard()",
      "_spiral": "note(\"c e g b\")._spiral()",
      "_spectrum": "s(\"bd sd hh sd\")._spectrum()"
    }
  }
}
